import("main.lib");

// constant Values
SRmax = 192000;
SR = ma.SR;
LengthSecMax = 10;

looper(i) = vgroup("looper", buffer)
with{
    offset = 2;
    info(i, lo, up) = _ <: _, hbargraph(" %i ", lo, up) : attach;
    cgui(x) = vgroup("controls", x);
    kgui(x) = hgroup("knobs", x);
    readSpeed = cgui(kgui(4 ^ 
                hslider("[0]Read Speed [style:knob][unit:_pitch]",0,-1,+1,0.01)));
    lengthSec = cgui(kgui(
                hslider("[0]Tape Length [style:knob][unit:_sec]",1, 1, LengthSecMax, 1)));
    recIndex =  1 / float(SR * lengthSec) : (+ : ma.frac : 
                hgroup("writing %i", info(1, 0, 1))) ~ 
                * (record) : * (float(SR * lengthSec)) + (offset * record) : int;
    readIndex = readSpeed/float(SR * lengthSec) : (+ : ma.frac : 
                hgroup("reading %i", info(1, 0, 1))) ~ _ : 
                * (float(SR * lengthSec)) : int;
    record =    cgui(checkbox("[1]Record %i") : int);
    buffer =    rwtable(SRmax * LengthSecMax + offset, 0.0, recIndex, _, readIndex + offset);
};
//process = looper(1);

walkergrains(i) = vgroup("looper", buffer)
with{
    offset = 2;
    info(i, lo, up) = _ <: _, hbargraph(" %i ", lo, up) : attach;
    cgui(x) = vgroup("controls", x);
    kgui(x) = hgroup("knobs", x);
    readSpeed = cgui(kgui(4 ^ 
                hslider("[0]Read Speed [style:knob][unit:_pitch]",0,-1,+1,0.01)));
    lengthSec = cgui(kgui(
                hslider("[0]Tape Length [style:knob][unit:_sec]",1, 1, LengthSecMax, 1) : int));
    recIndex =  1 / float(SR * lengthSec) : (+ : ma.frac : 
                hgroup("writing %i", info(1, 0, 1))) ~ 
                * (record) : * (float(SR * lengthSec)) + (offset * record) : int;
    mxsf = hslider("max dv[style:knob]",100, 1, 100, .001);
    mnsf = hslider("min dv[style:knob]",1.0, 1, 100, .001);
    readIndex = phasorRevers(1/lengthSec, mnsf, mxsf, i) :
                hgroup("reading %i", info(1, 0, 1))
                * (float(SR * lengthSec)) : int;
    record =    cgui(checkbox("[1]Record") : int);
    buffer =    rwtable(SRmax * LengthSecMax + offset, 0.0, recIndex, _, readIndex + offset);
};
//process = walkergrains(1), walkergrains(2);

polyloop(k, N) = hgroup("Mixer", vgroup("polyloop %k", _ <: par(i, N, buffer(i)) :> _ / N))
with{
    random(i) = sah2((button("seed") > button("seed")') + 
                ((1 - 1')@100), abs(noise(i)));
    offset = 2;
    info(i, lo, up) = _ <: _, hbargraph(" %i ", lo, up) : attach;
    cgui(x) = vgroup("controls", x);
    kgui(x) = hgroup("knobs", x);
    readSpeed = cgui(kgui(4 ^ 
                hslider("[0]Read Speed [style:knob][unit:_pitch]",0,-1,+1,0.01)));
    lengthSec = cgui(kgui(
                hslider("[0]Tape Length [style:knob][unit:_sec]",1, 1, LengthSecMax, 1) : int));
    recIndex =  1 / float(SR * lengthSec) : (+ : ma.frac : 
                hgroup("writing", info(1, 0, 1))) ~ 
                * (record) : * (float(SR * lengthSec)) + (offset * record) : int;
    readIndex(i) =  readSpeed/float(SR * lengthSec) : (+ : ma.frac) ~ _ : 
                    _ + random(i) : ma.frac : hgroup("reading %i", info(1, 0, 1)) :
                    _ * (float(SR * lengthSec)) : int;
    record =    cgui(checkbox("Record") : int);
    buffer(rnd) = rwtable(SRmax * LengthSecMax + offset, 0.0, recIndex, _, readIndex(rnd) + offset);
};
//process = _ <: polyloop(1, 4), polyloop(2, 4);